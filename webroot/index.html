<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Welcome to KRY</title>
</head>
<body>
KRY status poller
<ul id="service-list">
</ul>
<div>
    <div> url:
        <input type="text" id="url">
    </div>
    <div> name:
        <input type="text" id="name">
    </div>

</div>

<button id="post-service">Save</button>

</body>
<script>
    setInterval(() => {
        location.reload();
    }, 20000);

    const listContainer = document.querySelector('#service-list');
    const cookie = getOrSetDefaultCookie("kry");

    let servicesRequest = new Request('/service');
    fetch(servicesRequest, {
        method: 'get',
        headers: {
            'Cookie': cookie
        }
    })
        .then(function(response) {return response.json();})
        .then(function(serviceList) {
            serviceList.forEach(service => {
                let li = createServiceNode(service);
                listContainer.appendChild(li);
            });
        });

    const saveButton = document.querySelector('#post-service');
    saveButton.onclick = evt => {
        let url = document.querySelector('#url').value;
        let name = document.querySelector('#name').value;
        fetch('/service', {
            method: 'post',
            headers: {
                'Accept': 'application/json, text/plain, */*',
                'Content-Type': 'application/json',
                'Cookie': cookie
            },
            body: JSON.stringify({url:url, name: name})
        }).then(res=> {
            //TODO: handle 400 bad request and alert bad url format
            location.reload();
        });
    }

    function sendUpdate(originalName, originalUrl, updatedName, updatedUrl) {
        fetch('/service', {
            method: 'put',
            headers: {
                'Accept': 'application/json, text/plain, */*',
                'Content-Type': 'application/json',
                'Cookie': cookie
            },
            body: JSON.stringify({
                original_name: originalName,
                updated_name: updatedName,
                original_url: originalUrl,
                updated_url: updatedUrl
            })
        }).then(res => {
            location.reload();
        })
    }

    function sendDelete(sname, surl) {
        fetch('/service', {
            method: 'delete',
            headers: {
                'Accept': 'application/json, text/plain, */*',
                'Content-Type': 'application/json',
                'Cookie': cookie
            },
            body: JSON.stringify({name: sname, url:surl})
        }).then(res => {
            location.reload();
        })
    }

    function createServiceNode(service) {
        let li = document.createElement("li");
        let urlInput = createInputNode(service.url)
        let nameInput = createInputNode(service.name)
        li.appendChild(urlInput);
        li.appendChild(nameInput);
        li.appendChild(document.createTextNode(': ' + service.status));
        let updateButton = createUpdateButton(service, urlInput, nameInput);
        let deleteButton = createDeleteButton(li, service);
        li.appendChild(updateButton);
        li.appendChild(deleteButton);
        return li;
    }

    function createUpdateButton(service, urlInput, nameInput) {
        let updateButton = document.createElement("button");
        updateButton.innerText = "update";
        updateButton.addEventListener("click", () => {
            sendUpdate(service.name, service.url, nameInput.value, urlInput.value);
        })
        return updateButton;
    }

    function createDeleteButton(li, service) {
        let deleteButton = document.createElement("button");
        deleteButton.innerText = "delete";
        deleteButton.addEventListener("click", () => {
            listContainer.removeChild(li);
            sendDelete(service.name, service.url)
        });
        return deleteButton;
    }

    function createInputNode(value) {
        let input = document.createElement("input");
        input.setAttribute('type', 'text');
        input.setAttribute('value', value);
        return input;
    }

    function getOrSetDefaultCookie(cname) {
        if (getCookie(cname) === "") {
            let cookieValue = Math.random().toString(36).substring(7);
            document.cookie = cname + "= " + cookieValue + "; expires=Thu, 18 Dec 2020 12:00:00 UTC; path=/";
        }
        return getCookie(cname);
    }

    function getCookie(cname) {
        let name = cname + "=";
        let ca = document.cookie.split(';');
        for(let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }
</script>
</html>